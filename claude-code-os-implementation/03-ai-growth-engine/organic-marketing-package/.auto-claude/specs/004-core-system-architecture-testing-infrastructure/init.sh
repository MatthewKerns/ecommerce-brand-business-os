#!/bin/bash

# Auto-Build Environment Setup
# Generated by Planner Agent for Task 004
# Core System Architecture & Testing Infrastructure

set -e

echo "========================================"
echo "Starting Development Environment"
echo "========================================"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ============================================
# PYTHON ENVIRONMENT SETUP
# ============================================

echo ""
echo -e "${YELLOW}Setting up Python environment...${NC}"

# Check Python version
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}Python 3 is not installed${NC}"
    exit 1
fi

PYTHON_VERSION=$(python3 --version | cut -d' ' -f2)
echo -e "${GREEN}Python version: $PYTHON_VERSION${NC}"

# Create virtual environment if it doesn't exist
if [ ! -d "ai-content-agents/.venv" ]; then
    echo "Creating virtual environment..."
    cd ai-content-agents
    python3 -m venv .venv
    cd ..
    echo -e "${GREEN}Virtual environment created${NC}"
else
    echo -e "${GREEN}Virtual environment already exists${NC}"
fi

# Activate virtual environment
echo "Activating virtual environment..."
source ai-content-agents/.venv/bin/activate

# Install/upgrade dependencies
echo "Installing dependencies..."
cd ai-content-agents
pip install --upgrade pip
pip install -r requirements.txt

# Install development dependencies for testing
echo "Installing development dependencies..."
pip install pytest pytest-cov flake8 black

cd ..

# ============================================
# VERIFY ENVIRONMENT
# ============================================

echo ""
echo -e "${YELLOW}Verifying environment...${NC}"

# Check Anthropic API key
if [ -z "$ANTHROPIC_API_KEY" ]; then
    echo -e "${YELLOW}⚠️  ANTHROPIC_API_KEY not set${NC}"
    echo "Set it with: export ANTHROPIC_API_KEY='your-key-here'"
    echo "Or create ai-content-agents/.env file"
else
    echo -e "${GREEN}✓ ANTHROPIC_API_KEY is set${NC}"
fi

# Check if pytest is installed
if python -c "import pytest" 2>/dev/null; then
    echo -e "${GREEN}✓ pytest is installed${NC}"
else
    echo -e "${RED}✗ pytest is not installed${NC}"
    exit 1
fi

# Check if agents can be imported
cd ai-content-agents
if python -c "from agents import base_agent" 2>/dev/null; then
    echo -e "${GREEN}✓ Agent modules can be imported${NC}"
else
    echo -e "${RED}✗ Agent modules cannot be imported${NC}"
    exit 1
fi
cd ..

# ============================================
# CREATE REQUIRED DIRECTORIES
# ============================================

echo ""
echo -e "${YELLOW}Creating required directories...${NC}"

# Documentation directory
mkdir -p docs
echo -e "${GREEN}✓ docs/ directory ready${NC}"

# Database directory
mkdir -p ai-content-agents/database/migrations
echo -e "${GREEN}✓ ai-content-agents/database/ directory ready${NC}"

# Tests directory
mkdir -p ai-content-agents/tests/fixtures
echo -e "${GREEN}✓ ai-content-agents/tests/ directory ready${NC}"

# API directory
mkdir -p ai-content-agents/api/routes
echo -e "${GREEN}✓ ai-content-agents/api/ directory ready${NC}"

# Logs directory
mkdir -p ai-content-agents/logs
echo -e "${GREEN}✓ ai-content-agents/logs/ directory ready${NC}"

# GitHub workflows directory
mkdir -p .github/workflows
echo -e "${GREEN}✓ .github/workflows/ directory ready${NC}"

# ============================================
# SUMMARY
# ============================================

echo ""
echo "========================================"
echo "Environment Ready!"
echo "========================================"
echo ""
echo "Project Structure:"
echo "  ├── ai-content-agents/       Python content generation toolkit"
echo "  ├── docs/                    Architecture & design documentation"
echo "  ├── .github/workflows/       CI/CD pipeline configuration"
echo "  └── tests/                   Test suite"
echo ""
echo "Next Steps:"
echo "  1. Review implementation plan: cat .auto-claude/specs/004-core-system-architecture-testing-infrastructure/implementation_plan.json"
echo "  2. Start implementation: source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 004"
echo "  3. Run tests: pytest ai-content-agents/tests/ -v"
echo ""
echo "Virtual Environment:"
echo "  source ai-content-agents/.venv/bin/activate"
echo ""
echo "========================================"
