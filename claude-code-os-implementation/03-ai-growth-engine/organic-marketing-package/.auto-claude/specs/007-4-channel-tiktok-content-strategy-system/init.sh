#!/bin/bash

# Auto-Build Environment Setup
# Generated by Planner Agent for: 4-Channel TikTok Content Strategy System

set -e

echo "========================================"
echo "4-Channel TikTok Content Strategy System"
echo "Development Environment Setup"
echo "========================================"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
CONTENT_AGENTS_DIR="claude-code-os-implementation/03-ai-growth-engine/organic-marketing-package/content-agents"
API_PORT=8000

# Wait for service function
wait_for_service() {
    local port=$1
    local name=$2
    local max=30
    local count=0

    echo -e "${BLUE}Waiting for $name on port $port...${NC}"
    while ! nc -z localhost $port 2>/dev/null; do
        count=$((count + 1))
        if [ $count -ge $max ]; then
            echo -e "${RED}$name failed to start${NC}"
            return 1
        fi
        sleep 1
    done
    echo -e "${GREEN}$name ready on port $port${NC}"
}

# ============================================
# ENVIRONMENT CHECK
# ============================================

echo ""
echo -e "${BLUE}Checking environment...${NC}"

# Check if we're in the right directory
if [ ! -d "$CONTENT_AGENTS_DIR" ]; then
    echo -e "${RED}Error: Content agents directory not found${NC}"
    echo "Expected: $CONTENT_AGENTS_DIR"
    echo "Current directory: $(pwd)"
    exit 1
fi

# Check for Python
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}Error: Python 3 not found${NC}"
    exit 1
fi

echo -e "${GREEN}Environment check passed${NC}"

# ============================================
# DATABASE INITIALIZATION
# ============================================

echo ""
echo -e "${BLUE}Initializing database...${NC}"

cd "$CONTENT_AGENTS_DIR"

# Run database initialization
if [ -f "database/init_db.py" ]; then
    python3 database/init_db.py
    echo -e "${GREEN}Database initialized${NC}"
else
    echo -e "${YELLOW}Warning: database/init_db.py not found - skipping database init${NC}"
fi

# ============================================
# START API SERVICE
# ============================================

echo ""
echo -e "${BLUE}Starting Content Agents API...${NC}"

# Kill any existing process on the port
if lsof -Pi :$API_PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
    echo -e "${YELLOW}Port $API_PORT is in use. Stopping existing process...${NC}"
    lsof -ti:$API_PORT | xargs kill -9 2>/dev/null || true
    sleep 2
fi

# Start the API server in the background
uvicorn api.main:app --reload --host 0.0.0.0 --port $API_PORT > logs/api.log 2>&1 &
API_PID=$!
echo -e "${GREEN}API server started (PID: $API_PID)${NC}"

# Wait for API to be ready
wait_for_service $API_PORT "Content Agents API"

# ============================================
# INITIALIZE CHANNELS
# ============================================

echo ""
echo -e "${BLUE}Initializing 4 elemental TikTok channels...${NC}"

# This will be done via API or direct Python call once the agent is implemented
# For now, just log the intention
echo -e "${YELLOW}Channel initialization will be available after Phase 2 implementation${NC}"
echo -e "${YELLOW}Channels to create: Air, Water, Fire, Earth${NC}"

# ============================================
# SUMMARY
# ============================================

echo ""
echo "========================================"
echo -e "${GREEN}Environment Ready!${NC}"
echo "========================================"
echo ""
echo "Services:"
echo "  Content Agents API: http://localhost:$API_PORT"
echo "  API Documentation:  http://localhost:$API_PORT/api/docs"
echo "  ReDoc:              http://localhost:$API_PORT/api/redoc"
echo ""
echo "Logs:"
echo "  API: $CONTENT_AGENTS_DIR/logs/api.log"
echo ""
echo "Process IDs:"
echo "  API Server: $API_PID"
echo ""
echo -e "${BLUE}To view API logs:${NC}"
echo "  tail -f $CONTENT_AGENTS_DIR/logs/api.log"
echo ""
echo -e "${BLUE}To stop services:${NC}"
echo "  kill $API_PID"
echo ""
echo -e "${GREEN}Ready to implement 4-Channel TikTok Content Strategy!${NC}"
echo "========================================"
