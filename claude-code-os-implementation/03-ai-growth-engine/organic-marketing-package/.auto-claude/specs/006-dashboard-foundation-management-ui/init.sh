#!/bin/bash

# Auto-Build Environment Setup
# Generated by Planner Agent for Dashboard Foundation & Management UI

set -e

echo "========================================"
echo "Dashboard Foundation - Environment Setup"
echo "========================================"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Wait for service function
wait_for_service() {
    local port=$1
    local name=$2
    local max=30
    local count=0

    echo -n "Waiting for $name on port $port..."
    while ! nc -z localhost $port 2>/dev/null; do
        count=$((count + 1))
        if [ $count -ge $max ]; then
            echo -e "${RED}FAILED${NC}"
            echo -e "${RED}$name failed to start after ${max}s${NC}"
            return 1
        fi
        sleep 1
        echo -n "."
    done
    echo -e "${GREEN}OK${NC}"
}

# ============================================
# CHECK PREREQUISITES
# ============================================

echo ""
echo -e "${BLUE}Checking prerequisites...${NC}"

# Check Node.js
if ! command -v node &> /dev/null; then
    echo -e "${RED}Node.js is not installed!${NC}"
    echo "Please install Node.js 18+ from https://nodejs.org/"
    exit 1
fi
echo -e "${GREEN}✓${NC} Node.js $(node --version)"

# Check npm
if ! command -v npm &> /dev/null; then
    echo -e "${RED}npm is not installed!${NC}"
    exit 1
fi
echo -e "${GREEN}✓${NC} npm $(npm --version)"

# Check Python (for ai-content-agents integration)
if ! command -v python3 &> /dev/null; then
    echo -e "${YELLOW}⚠${NC} Python3 not found - Python agents won't be available"
else
    echo -e "${GREEN}✓${NC} Python $(python3 --version)"
fi

# ============================================
# DASHBOARD SETUP (if not already initialized)
# ============================================

if [ ! -d "dashboard" ]; then
    echo ""
    echo -e "${BLUE}Dashboard directory not found - needs initialization${NC}"
    echo "Run Phase 1 subtask 1-1 to initialize the Next.js project"
    echo ""
    echo "Command: npx create-next-app@latest dashboard --typescript --tailwind --app --src-dir --no-git"
    echo ""
    exit 0
fi

# ============================================
# INSTALL DEPENDENCIES
# ============================================

echo ""
echo -e "${BLUE}Installing dependencies...${NC}"

cd dashboard
if [ ! -d "node_modules" ]; then
    echo "Running npm install..."
    npm install
else
    echo -e "${GREEN}✓${NC} Dependencies already installed"
fi
cd ..

# ============================================
# ENVIRONMENT VARIABLES CHECK
# ============================================

echo ""
echo -e "${BLUE}Checking environment variables...${NC}"

if [ ! -f "dashboard/.env.local" ]; then
    echo -e "${YELLOW}⚠${NC} .env.local not found"
    if [ -f "dashboard/.env.local.example" ]; then
        echo "Creating .env.local from .env.local.example..."
        cp dashboard/.env.local.example dashboard/.env.local
        echo -e "${YELLOW}⚠${NC} Please edit dashboard/.env.local and add your Clerk API keys"
        echo ""
        echo "Required variables:"
        echo "  - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY"
        echo "  - CLERK_SECRET_KEY"
        echo ""
        echo "Get your keys from: https://clerk.com/"
        echo ""
        exit 0
    else
        echo -e "${YELLOW}⚠${NC} No .env.local.example found either"
        echo "Environment setup will be handled in Phase 1"
    fi
else
    echo -e "${GREEN}✓${NC} .env.local exists"
fi

# ============================================
# START DASHBOARD DEV SERVER
# ============================================

echo ""
echo -e "${BLUE}Starting dashboard development server...${NC}"
echo ""

cd dashboard

# Start Next.js dev server
echo "Starting Next.js on port 3000..."
npm run dev &
DASHBOARD_PID=$!

cd ..

# Wait for dashboard to be ready
wait_for_service 3000 "Dashboard"

# ============================================
# SUMMARY
# ============================================

echo ""
echo "========================================"
echo -e "${GREEN}Environment Ready!${NC}"
echo "========================================"
echo ""
echo "Services:"
echo "  Dashboard:  ${GREEN}http://localhost:3000${NC}"
echo ""
echo "To stop services:"
echo "  Press Ctrl+C or run: kill $DASHBOARD_PID"
echo ""
echo "Next steps:"
echo "  1. Open http://localhost:3000 in your browser"
echo "  2. Continue with implementation phases"
echo "  3. Configure Clerk authentication when prompted"
echo ""
echo "Build progress tracked in:"
echo "  ./.auto-claude/specs/006-dashboard-foundation-management-ui/build-progress.txt"
echo ""
